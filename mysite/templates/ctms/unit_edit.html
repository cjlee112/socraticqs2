{% extends 'ctms_base.html' %}

{% block title %}
Create new courselet
{% endblock %}

{% block content %}
<div class="card">
  <header class="card__topbar">
    <h1>{{ unit.lesson.title }}</h1>
  </header>

  <!-- TODO: We don't need this if when new and edit are separate views -->
  {% if pk %}
    <nav class="card__nav">
      <ul>
        <li>
          <a href="{% url 'ctms:unit_edit' course_pk=course.id courslet_pk=courslet.id pk=pk %}" class="card__nav-active">Edit</a>
        </li>

        <li>
          <a href="{% url 'ctms:unit_view' course_pk=course.id courslet_pk=courslet.id pk=pk %}">Answers</a>
        </li>

        <li>
          <a href="{% url 'ctms:unit_settings' course_pk=course.id courslet_pk=courslet.id pk=pk %}">Settings</a>
        </li>
      </ul>
    </nav>
  {% endif %}

  <main class="card__content">
    <form action="{% url 'ctms:unit_edit' course_pk=course.id courslet_pk=courslet.id pk=pk %}" method="POST">
      <!--TODO: {# post data and redirect to {% url 'ctms:add_unit_edit' course_pk=course.id courslet_pk=courslet.id pk=pk %} #}-->

      {% csrf_token %}

      {{ errors_formset.management_form }}

        <!-- Name -->
        <div class="form-group">
          <label for="{{ form.title.auto_id }}">Thread Name</label>

          <p>
            Give your thread a descriptive name. This will show up as a thread in your students sidebar.
          </p>
          <div class="expandable">
            <a class="expandable__toggle" href="#">How to name a thread</a>

            <div class="expandable__content">
              <ul style="margin-top: 12px; padding-left: 24px;">
                <li>Choose a name that's <b>short</b> (a few words) and <b>distinct</b> (helps students easily recognize this specific question in your courselet's list of questions, shown in the sidebar).</li>
                <li>For example, if your courselet presented questions about probability, and this question was the only one that featured trains (as an example), you could name it something like "Two Trains".</li>
                <li>Don't try to make the name a summary of what the question's asking -- that will be too long.</li>
              </ul>
            </div>
          </div>

          {{ form.title }}
          {% if form.title.errors %}
            {{ form.title.errors }}
          {% endif %}
          <!-- <input type="text"> -->
        </div>



        <!-- Unit type -->
        <div class="form-group">
          <label for="{{ form.unit_type.auto_id }}">Thread Type</label>

          <p>{{ form.unit_type.help_text }}</p>

          <div class="radio-list">
            {{ form.unit_type }}
          </div>
          {% if form.unit_type.errors %}
            {{ form.unit_type.errors }}
          {% endif %}
        </div>



        <!-- TODO: Introduction and question should be separate inputs, form.text is currently displayed twice -->
        <!-- Introduction -->
        <div class="form-group form-group--introduction">
          <label for="{{ form.text.auto_id }}">Introduction</label>

          <p>
            Write your introduction here. You can use <a href="http://www.sphinx-doc.org/en/master/usage/restructuredtext/basics.html" target="_blank">ReStructuredText</a> to format your text.

            <span class="expandable">
              <a class="expandable__toggle" href="#">How to write a good introduction</a>

              <span class="expandable__content">
                <br> Add a longer description here.
              </span>
            </span>
          </p>

        </div>



        <!-- Question -->
        <div class="form-group form-group--question">
          <label for="{{ form.text.auto_id }}">Question</label>

          <p>
            Write your question here. You can use <a href="http://www.sphinx-doc.org/en/master/usage/restructuredtext/basics.html" target="_blank">ReStructuredText</a> to format your text.
          </p>
          <div class="expandable">
            <a class="expandable__toggle" href="#"><span>How to write a good question</a></span>

            <div class="expandable__content">
              <ul style="margin-top: 12px; padding-left: 24px;">
                <li>Take a real-world situation that's representative of how you think students should be able to apply a concept you've taught, but which is different from examples you have already shown them how to solve.</li>
                <li>Focus your question small enough that students only need to think about that one concept.</li>
                <li>Hide in plain sight (difficulty level): correct application of the concept should lead pretty directly to the right answer (without requiring difficult usage of other skills such as solving equations), but it should not be guessable. In general, about 1/3 to 2/3 of your students should be able to do it.</li>
                <li>Your question should ask for a definite, specific answer (so that it's easy for students to self-assess whether their answer is right, by comparison with your answer).</li>
                <li>Your question should also ask students to briefly explain their reasoning for how they arrived at their answer, so that you'll be able to diagnose the underlying conceptual errors directly from students' responses.</li>
                <li>Keep your question SHORT, like a real chat conversation on Slack. If it seems too long, use various ways to split it into smaller pieces: background explanations should be moved to a separate Introduction thread; state your question briefly, and if you're concerned some students may need additional clarifications, provide them in an embedded audio or video clip.</li>
              </ul>
            </div>
          </div>

        </div>

        {{ form.text }}
        {% if form.text.errors %}
          {{ form.text.errors }}
        {% endif %}

        <!-- Answer -->
        <div class="form-group form-group--answer">
          <label for="{{ answer_form.answer.auto_id }}">{{ answer_form.answer.label }}</label>

          <p>
            Write your answer here. You can use <a href="http://www.sphinx-doc.org/en/master/usage/restructuredtext/basics.html" target="_blank">ReStructuredText</a> to format your text.

            <span class="expandable">
              <a class="expandable__toggle" href="#">How to write a good answer</a>

              <span class="expandable__content">
                <br> Add a longer description here.
              </span>
            </span>
          </p>

          {{ answer_form.answer }}
          {% if answer_form.answer.errors %}
            {{ answer_form.answer.errors }}
          {% endif %}
        </div>



        <!-- Error models -->
        <div class="form-group form-group--error-models">
          <label>Error Models <span>– optional</span></label>

          <p>
            An error model explains a common misconception. Your students can select error models when they self-assess.

            <span class="expandable">
              <a class="expandable__toggle" href="#">How to write a good error model</a>

              <span class="expandable__content">
                <br> Add a longer description here.
              </span>
            </span>
          </p>

          {% if errors_formset %}
            <div class="error-models-form">

              <div class="error-models-form__items">
                {% for item_form in errors_formset %}
                  <div id="item-{{ forloop.counter0 }}">
                    <!--{#{ item_form.as_p }#}-->
                    {% for field in item_form %}
                      {% if field.is_hidden %}
                        {{ field }}
                      {% else %}
                        <label for="{{ field.auto_id }}">{{ field.label }}</label>
                        {{ field }}
                        {% if field.errors %}
                          {{ field.errors }}
                        {% endif %}
                      {% endif %}
                    {% endfor %}
                    {# <!-- or for crispy forms --> {% crispy item_form %} #}
                    <a href="#" class="error-models-form__remove">Remove error model</a>

                    {% if course_pk and courslet and item_form.ul_id.value %}
                      <div class="alert alert-info">
                        <a class="edit-resolutions" href="{% url 'ct:resolutions' course_id=course_pk unit_id=courslet.unit.id ul_id=item_form.ul_id.value %}">Switch to the old Instructor UI</a> if you want to add resolutions.
                      </div>
                    {% endif %}
                  </div>
                {% endfor %}
              </div>

              <a href="#" class="button error-models-form__add">Add Error Model</a>
            </div>
          {% endif %}
        </div>



      <!-- Submit -->
      <input type="submit" value="Save">
    </form>
  </main>
</div>
{% endblock %}

{% block js %}
  <script>
    // Courselets namespace
    var Courselets = Courselets || {};

    // Toggles inputs visibility based on unit type
    Courselets.updateUnitType = function() {
      // Get current unit type
      var unitType = $("input[name=unit_type]:checked").val();

      // Question
      if(unitType === "{{ unit.lesson.ORCT_QUESTION }}") {
        $(".form-group--question, .form-group--answer, .form-group--error-models").show();
        $(".form-group--introduction").hide();

      // Introduction
      } else if(unitType === "{{ unit.lesson.EXPLANATION }}") {
        $(".form-group--introduction").show();
        $(".form-group--question, .form-group--answer, .form-group--error-models").hide();
      }
    };

    // Init the form once the document is ready
    $(function(){
      // Update form based on the current unit type
      Courselets.updateUnitType();

      // Listen to unit type changes
      $("input[name='unit_type']").on('change', function(){
        Courselets.updateUnitType();
      });

      // Listen to new error model button
      $('.error-models-form__add').on('click', function(e) {
        e.preventDefault();

        // Add new error model inputs
        var count = $('.error-models-form__items').children().length;
        var tmplMarkup = $('#item-template').html();
        var compiledTmpl = tmplMarkup.replace(/__prefix__/g, count);
        $('.error-models-form__items').append(compiledTmpl);

        // Update form count
        $('#id_form-TOTAL_FORMS').attr('value', count+1);

        // Animate scroll to the new form
        $('html, body').animate({
          scrollTop: $('.error-models-form__items div:last-of-type').offset().top - 84
        }, 800);
      });

      $('.error-models-form__remove').on('click', function(e) {
        var me = $(this);
        me.siblings('input[id*="-DELETE"]').val('on');
        me.closest('form').submit();
        e.preventDefault();
      });

      $('.edit-resolutions').on('click', function (e) {
          var form = $(this).closest('form');
          var action = form.attr('action');
          e.preventDefault();
          $.ajax({
              url: action,
              type: 'POST',
              data: form.serializeArray(),
              async: false,
              success: function (response) {
                  window.location.href = $(e.currentTarget).attr('href');
              }
          });
      });
    });
  </script>

  <!-- Error model template -->
  <script type="text/html" id="item-template">
    <div id="item-__prefix__">
      <!--{#{ errors_formset.empty_form.as_p }#}-->

      {% for field in errors_formset.empty_form %}
        {% if field.is_hidden %}
          {{ field }}
        {% else %}
          <label for="{{ field.auto_id }}">{{ field.label }}</label>
          {{ field }}
        {% endif %}
      {% endfor %}
      <!-- crispy: {#% crispy item_forms.empty_form item_forms.form.helper %#} -->
    </div>
  </script>
{% endblock %}
